--// Lib UI
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()
local Window = OrionLib:MakeWindow({Name = "Fruit Hub FINAL", HidePremium = false, SaveConfig = true, ConfigFolder = "FruitHub"})

-- Tabs
local FarmTab = Window:MakeTab({Name = "Farm Fruit", Icon = "rbxassetid://4483345998", PremiumOnly = false})
local HakiTab = Window:MakeTab({Name = "Farm Haki", Icon = "rbxassetid://4483345998", PremiumOnly = false})
local AutoFruitTab = Window:MakeTab({Name = "Auto Fruit", Icon = "rbxassetid://4483345998", PremiumOnly = false})
local SettingTab = Window:MakeTab({Name = "Settings", Icon = "rbxassetid://4483345998", PremiumOnly = false})

-- Player
local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")

--// ================= FARM FRUIT =================
local AutoSkills = {
    Z = false,
    X = false,
    C = false,
    V = false,
    R = false -- thêm phím R nếu farm haki riêng
}

-- Spam skill
task.spawn(function()
    while task.wait(0.2) do
        for key, state in pairs(AutoSkills) do
            if state then
                game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode[key], false, game)
                task.wait(0.05)
                game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode[key], false, game)
            end
        end
    end
end)

FarmTab:AddToggle({Name="Auto Z", Default=false, Callback=function(v) AutoSkills.Z = v end})
FarmTab:AddToggle({Name="Auto X", Default=false, Callback=function(v) AutoSkills.X = v end})
FarmTab:AddToggle({Name="Auto C", Default=false, Callback=function(v) AutoSkills.C = v end})
FarmTab:AddToggle({Name="Auto V", Default=false, Callback=function(v) AutoSkills.V = v end})

--// ================= FARM HAKI =================
local AutoHaki = false
HakiTab:AddToggle({
    Name="Auto Farm Haki (R)",
    Default=false,
    Callback=function(v)
        AutoHaki = v
        AutoSkills.R = v -- dùng phím R để bật haki liên tục
    end
})

--// ================= AUTO FRUIT =================
local RF_RareDevilfruit = {
    "Smoke","Sand","Rumble","Quake","Phoenix","Ope","Magma","Light",
    "Hollow","Alice","Gas","Flare","Dark","Chilly","Candy",
    "Plasma","Gravity","Vampire","Venom","Snow","Luck"
}

local FruitToggles = {}
for _, fruitName in ipairs(RF_RareDevilfruit) do
    FruitToggles[fruitName] = false
end

local function pickFruit(fruitModel)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and fruitModel:FindFirstChild("Handle") then
        player.Character.HumanoidRootPart.CFrame = fruitModel.Handle.CFrame + Vector3.new(0,2,0)
        task.wait(0.05)
        local cd = fruitModel.Handle:FindFirstChildOfClass("ClickDetector")
        if cd then fireclickdetector(cd) end
    end
end

-- Check liên tục
task.spawn(function()
    while task.wait(0.2) do
        for _, v in pairs(workspace:GetChildren()) do
            if v:IsA("Tool") or v:IsA("Model") then
                for fruit, enabled in pairs(FruitToggles) do
                    if enabled and string.find(v.Name, fruit) and string.find(v.Name, "Fruit") then
                        pickFruit(v)
                    end
                end
            end
        end
    end
end)

-- Nếu có trái mới spawn
workspace.ChildAdded:Connect(function(v)
    task.wait(0.05)
    if v:IsA("Tool") or v:IsA("Model") then
        for fruit, enabled in pairs(FruitToggles) do
            if enabled and string.find(v.Name, fruit) and string.find(v.Name, "Fruit") then
                pickFruit(v)
            end
        end
    end
end)

-- UI Auto Fruit
for _, fruitName in ipairs(RF_RareDevilfruit) do
    AutoFruitTab:AddToggle({
        Name = fruitName,
        Default = false,
        Callback = function(Value)
            FruitToggles[fruitName] = Value
        end    
    })
end

--// ================= SETTINGS =================
SettingTab:AddButton({
    Name = "Rejoin Server",
    Callback = function()
        game:GetService("TeleportService"):Teleport(game.PlaceId, game.Players.LocalPlayer)
    end
})

-- Hotkey toggle UI
local UserInputService = game:GetService("UserInputService")
local Hotkey = Enum.KeyCode.RightControl
local hotkeyConnection

SettingTab:AddTextbox({
    Name = "Hotkey Toggle (default RightCtrl)",
    Default = "RightControl",
    TextDisappear = true,
    Callback = function(value)
        local success, key = pcall(function()
            return Enum.KeyCode[value]
        end)
        if success and key then
            Hotkey = key
            if hotkeyConnection then hotkeyConnection:Disconnect() end
            hotkeyConnection = UserInputService.InputBegan:Connect(function(input, gpe)
                if not gpe and input.KeyCode == Hotkey then
                    OrionLib:ToggleUI()
                end
            end)
        end
    end
})

-- Gắn hotkey ban đầu
hotkeyConnection = UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Hotkey then
        OrionLib:ToggleUI()
    end
end)
