-- ================================================================= --
-- NTBA FARM HUB - V21.2.6 (FINAL FIX: CHI√äU TH·∫≤NG & B·ªé LOCK CHU·ªòT HAKI)
-- ================================================================= --

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local ContextActionService = game:GetService("ContextActionService") 
local player = Players.LocalPlayer
local Character = player.Character or player.CharacterAdded:Wait()
local hrp = Character:WaitForChild("HumanoidRootPart")
local Backpack = player:WaitForChild("Backpack")

local AutoFarmNPC = false
local FarmRadius = 150
local AutoSkillState={Z=false,X=false,C=false,V=false}

local AutoDropItem = false
local AutoDropItemPlus = false

local AutoHakiRState = false 
local AutoHakiQState = false 

local Hotkey = Enum.KeyCode.RightControl
local HubVisible = true
local isEscPressed = false 

local DEFAULT_INTERVAL = 0.15
local SAMPLE_WINDOW = 6
local MIN_INTERVAL = 0.02
local MAX_INTERVAL = 3
local currentMode = "Adaptive" 

local CooldownData = {
    pressCount = 0,
    successCount = 0,
    lastSamples = {},
    lastPressTime = 0
}

local ITEM_DROP_LIST = {
    ["Apple"] = true, ["Cantaloup"] = true, ["Cantaloupe"] = true, ["Banana"] = true,
    ["Green Apple"] = true, ["Coconut"] = true, ["Pumpkin"] = true, ["Prickly Pear"] = true,
    ["Melon"] = true,
}
local ITEM_DROP_PLUS_LIST = {
    ["Cider+"] = true, ["Lemonade+"] = true, ["Juice+"] = true, ["Smoothie+"] = true,
}

local function findDroppableItemInList(dropList)
    for _, item in ipairs(Backpack:GetChildren()) do
        if (item:IsA("Tool") or item:IsA("HopperBin")) and dropList[item.Name] then
            return item
        end
    end
    return nil
end

local function doKeyTap(keyName)
    pcall(function()
        local vim = VirtualInputManager
        vim:SendKeyEvent(true, keyName, false, game)
        task.wait(0.01)
        vim:SendKeyEvent(false, keyName, false, game)
    end)
    return true
end

local function simpleClamp(n, lo, hi)
    if n < lo then return lo end
    if n > hi then return hi end
    return n
end

local function simpleReadGUI(obj)
    if not obj then return nil end
    local ok, val = pcall(function()
        if obj:IsA("GuiObject") then
            return obj.Size.X.Scale
        end
        return nil
    end)
    return ok and val or nil
end

local function simpleFindGUI()
    local pg = player:FindFirstChild("PlayerGui")
    if not pg then return nil end
    
    for _, obj in ipairs(pg:GetDescendants()) do
        if obj:IsA("GuiObject") and (obj.Name:lower():find("bar") or obj.Name:lower():find("cooldown")) then
            return obj
        end
    end
    return nil
end

local function getSmartInterval()
    if #CooldownData.lastSamples == 0 then
        return DEFAULT_INTERVAL
    end
    
    local total = 0
    for _, sample in ipairs(CooldownData.lastSamples) do
        total = total + sample
    end
    local avg = total / #CooldownData.lastSamples
    
    return simpleClamp(avg - 0.05, MIN_INTERVAL, MAX_INTERVAL)
end

-- üî• ƒê√É B·ªé L·ªÜNH KH√ìA CHU·ªòT (LU√îN TR·∫¢ V·ªÄ DEFAULT)
local function forceLockMouse(shouldLock)
    -- Gi·ªØ nguy√™n chu·ªôt ·ªü tr·∫°ng th√°i m·∫∑c ƒë·ªãnh (Default)
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
end


player.CharacterAdded:Connect(function(newCharacter)
    Character = newCharacter
    hrp = newCharacter:WaitForChild("HumanoidRootPart")
end)


pcall(function()
    if player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("FruitHubUI") then
        player.PlayerGui.FruitHubUI:Destroy()
    end
end)

local PlayerGui = player:WaitForChild("PlayerGui", 5)
if not PlayerGui then return end

-- ================================================================= --
--                             UI SETUP
-- ================================================================= --

local MAIN_W, MAIN_H = 600, 380
local Sidebar_W = 130
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FruitHubUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Main = Instance.new("Frame")
Main.Name = "Main"
Main.Size = UDim2.new(0, MAIN_W, 0, MAIN_H)
Main.Position = UDim2.new(0.5, -MAIN_W/2, 0.12, 0)
Main.BackgroundColor3 = Color3.fromRGB(24,24,28)
Main.BackgroundTransparency = 0.15
Main.BorderSizePixel = 0
Main.Parent = ScreenGui
Instance.new("UICorner", Main).CornerRadius = UDim.new(0,12)

local shadow = Instance.new("UIStroke", Main)
shadow.Color = Color3.fromRGB(85, 170, 255)
shadow.Thickness = 2
shadow.Transparency = 0.6

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1,0,0,32)
TitleBar.Position = UDim2.new(0,0,0,0)
TitleBar.BackgroundColor3 = Color3.fromRGB(32,32,36)
TitleBar.BackgroundTransparency = 0.15
TitleBar.BorderSizePixel = 0
TitleBar.Parent = Main
Instance.new("UICorner", TitleBar).CornerRadius = UDim.new(0,12)

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(0.6,-10,1,0)
TitleLabel.Position = UDim2.new(0,10,0,0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "NTBA ‚Ä¢ Farm Hub (V21.2.6 - FIX CU·ªêI C√ôNG)" 
TitleLabel.TextSize = 15
TitleLabel.TextColor3 = Color3.fromRGB(170, 255, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local AuthorLabel = Instance.new("TextLabel")
AuthorLabel.Size = UDim2.new(0.3,-10,1,0)
AuthorLabel.Position = UDim2.new(0.7,10,0,0)
AuthorLabel.BackgroundTransparency = 1
AuthorLabel.Font = Enum.Font.Gotham
AuthorLabel.Text = "Author: NTBA"
AuthorLabel.TextSize = 12
AuthorLabel.TextColor3 = Color3.fromRGB(160,160,160)
AuthorLabel.TextXAlignment = Enum.TextXAlignment.Right
AuthorLabel.Parent = TitleBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0,30,0,24)
CloseBtn.Position = UDim2.new(1,-38,0,4)
CloseBtn.BackgroundColor3 = Color3.fromRGB(180,60,60)
CloseBtn.Text = "X"
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 13
CloseBtn.TextColor3 = Color3.fromRGB(255,255,255)
CloseBtn.BorderSizePixel = 0
CloseBtn.BackgroundTransparency = 0.1
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0,6)
CloseBtn.Parent = TitleBar
CloseBtn.MouseButton1Click:Connect(function()
    forceLockMouse(false) 
    ScreenGui:Destroy()
    script:Destroy()
end)

do
    local dragging = false
    local dragStart, startPos
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 then
            dragging=true
            dragStart=input.Position
            startPos=Main.Position
            input.Changed:Connect(function()
                if input.UserInputState==Enum.UserInputState.End then dragging=false end
            end)
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
            local delta=input.Position - dragStart
            Main.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X,startPos.Y.Scale,startPos.Y.Offset+delta.Y)
        end
    end)
end

UserInputService.InputBegan:Connect(function(input, gpe)
    if input.KeyCode == Hotkey and not gpe then
        HubVisible = not HubVisible
        ScreenGui.Enabled = HubVisible
    end

    if input.KeyCode == Enum.KeyCode.Escape then
        isEscPressed = true
        forceLockMouse(false) 
    end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if input.KeyCode == Enum.KeyCode.Escape then
        isEscPressed = false
        -- KH√îNG C·∫¶N G·ªåI forceLockMouse(true) V√å H√ÄM ƒê√É B·ªä V√î HI·ªÜU H√ìA
    end
end)

local Sidebar = Instance.new("Frame")
Sidebar.Size = UDim2.new(0,Sidebar_W,1,-32)
Sidebar.Position = UDim2.new(0,0,0,32)
Sidebar.BackgroundColor3 = Color3.fromRGB(36,36,38)
Sidebar.BackgroundTransparency = 0.15
Sidebar.BorderSizePixel = 0
Sidebar.Parent = Main
Instance.new("UICorner", Sidebar).CornerRadius = UDim.new(0,10)

local tabs = {"AutoFarm","AutoNPC","AutoHaki","Fruit Mix","Settings"} 
local tabButtons, panels = {}, {}

local SidebarLayout = Instance.new("UIListLayout", Sidebar)
SidebarLayout.Padding = UDim.new(0,6)
SidebarLayout.SortOrder = Enum.SortOrder.LayoutOrder
SidebarLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
SidebarLayout.VerticalAlignment = Enum.VerticalAlignment.Top

local Panel_X_Start = Sidebar_W + 10
local Panel_Y_Start = 32 + 10
local Panel_W = MAIN_W - Sidebar_W - 20
local Panel_H = MAIN_H - 32 - 20

for i,name in ipairs(tabs) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-10,0,32)
    btn.BackgroundColor3 = Color3.fromRGB(44,44,46)
    btn.BackgroundTransparency = 0.2
    btn.BorderSizePixel = 0
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Text = name
    btn.Parent = Sidebar
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
    btn.LayoutOrder = i
    tabButtons[name] = btn

    local panel = Instance.new("Frame")
    panel.Name = name .. "Panel"
    panel.Size = UDim2.new(0, Panel_W, 0, Panel_H)
    panel.Position = UDim2.new(0, Panel_X_Start, 0, Panel_Y_Start)
    panel.BackgroundTransparency = 1
    panel.Visible = false
    panel.Parent = Main
    panels[name] = panel
end

panels["AutoFarm"].Visible = true
tabButtons["AutoFarm"].BackgroundColor3 = Color3.fromRGB(60,60,62)
tabButtons["AutoFarm"].BackgroundTransparency = 0.1

for name, btn in pairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        for k,v in pairs(tabButtons) do v.BackgroundColor3 = Color3.fromRGB(44,44,46); v.BackgroundTransparency = 0.2 end
        for _,p in pairs(panels) do p.Visible = false end
        btn.BackgroundColor3 = Color3.fromRGB(60,60,62)
        btn.BackgroundTransparency = 0.1
        panels[name].Visible = true
    end)
end

-- ================================================================= --
--                             AUTO FARM PANEL 
-- ================================================================= --

local AutoFarmPanel = panels["AutoFarm"]
do
    local p = AutoFarmPanel
    local y=6
    local label=Instance.new("TextLabel",p)
    label.Size=UDim2.new(1,0,0,24)
    label.Position=UDim2.new(0,0,0,y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(220,220,220)
    label.Text="Auto Skills (spam keys)"
    y=y+30

    local x_start = 10
    local spacing = (Panel_W - (100 * 4 + x_start * 2)) / 3

    for i,key in ipairs({"Z","X","C","V"}) do
        local btn=Instance.new("TextButton",p)
        btn.Size=UDim2.new(0,100,0,32)
        btn.Position=UDim2.new(0,x_start+(i-1)*(100+spacing),0,y)
        btn.Text=key.." OFF"
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 14
        btn.TextColor3 = Color3.fromRGB(230,230,230)
        btn.BackgroundColor3 = Color3.fromRGB(60,60,62)
        btn.BackgroundTransparency = 0.15
        btn.BorderSizePixel = 0
        Instance.new("UICorner",btn).CornerRadius = UDim.new(0,6)
        local state=false
        btn.MouseButton1Click:Connect(function()
            state=not state
            AutoSkillState[key]=state
            btn.Text=key..(state and " ON" or " OFF")
            btn.BackgroundColor3=state and Color3.fromRGB(0,170,255) or Color3.fromRGB(60,60,62)
            btn.BackgroundTransparency=state and 0.1 or 0.15
        end)
    end
end

-- V√íNG L·∫∂P AUTO SKILL (CHI√äU TH·∫≤NG - KH√îNG ·∫¢NH H∆Ø·ªûNG B·ªûI CHU·ªòT)
task.spawn(function()
    while true do
        task.wait(0.1)
        
        if not AutoFarmNPC and not isEscPressed then
            for key,enabled in pairs(AutoSkillState) do
                if enabled then
                    
                    -- 1. BU·ªòC NH√ÇN V·∫¨T QUAY TH·∫≤NG V·ªÄ H∆Ø·ªöNG CAMERA 
                    if hrp and game.Workspace.CurrentCamera then
                        local camLook = game.Workspace.CurrentCamera.CFrame.LookVector
                        local targetPos = hrp.Position + Vector3.new(camLook.X, 0, camLook.Z) 
                        hrp.CFrame = CFrame.new(hrp.Position, targetPos)
                    end
                    
                    pcall(function()
                        -- 2. NH·∫§N PH√çM CHI√äU TH·ª®C (Z/X/C/V)
                        VirtualInputManager:SendKeyEvent(true,key,false,game)
                        task.wait(0.04)
                        VirtualInputManager:SendKeyEvent(false,key,false,game)
                        
                        -- 3. G·ª¨I T√çN HI·ªÜU NH·∫§P CHU·ªòT TR√ÅI GI·∫¢ (BU·ªòC CHI√äU K√çCH HO·∫†T TH·∫≤NG)
                        VirtualInputManager:SendMouseButtonEvent(0, true, game) 
                        task.wait(0.01) 
                        VirtualInputManager:SendMouseButtonEvent(0, false, game) 
                        
                    end)
                    task.wait(0.1) 
                end
            end
        end
    end
end)

-- ================================================================= --
--                             AUTO NPC PANEL (GI·ªÆ NGUY√äN)
-- ================================================================= --

local AutoNPCPanel = panels["AutoNPC"]
do
    local p = AutoNPCPanel
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, y)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 170, 0)
    label.Text = "AUTO FARM NPC (T·ª± ƒë·ªông ƒë√°nh qu√°i)"
    y = y + 30

    local masterBtn = Instance.new("TextButton", p)
    masterBtn.Size = UDim2.new(0, 200, 0, 32)
    masterBtn.Position = UDim2.new(0, 10, 0, y)
    masterBtn.Text = "Auto Farm NPC: OFF"
    masterBtn.Font = Enum.Font.GothamBold
    masterBtn.TextSize = 14
    masterBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    masterBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
    masterBtn.BackgroundTransparency = 0.15
    masterBtn.BorderSizePixel = 0
    Instance.new("UICorner", masterBtn).CornerRadius = UDim.new(0, 6)

    masterBtn.MouseButton1Click:Connect(function()
        AutoFarmNPC = not AutoFarmNPC
        masterBtn.Text = "Auto Farm NPC: " .. (AutoFarmNPC and "ON" or "OFF")
        masterBtn.BackgroundColor3 = AutoFarmNPC and Color3.fromRGB(0, 150, 255) or Color3.fromRGB(150, 50, 50)
        masterBtn.BackgroundTransparency = AutoFarmNPC and 0.1 or 0.15
    end)
    y = y + 42

    local lblRange = Instance.new("TextLabel", p)
    lblRange.Size = UDim2.new(0, 250, 0, 18)
    lblRange.Position = UDim2.new(0, 10, 0, y)
    lblRange.BackgroundTransparency = 1
    lblRange.Font = Enum.Font.Gotham
    lblRange.TextSize = 12
    lblRange.TextColor3 = Color3.fromRGB(200, 200, 200)
    lblRange.Text = "Ph·∫°m vi t√¨m ki·∫øm: " .. FarmRadius .. " studs (M·∫∑c ƒë·ªãnh)"
    lblRange.TextXAlignment = Enum.TextXAlignment.Left
    y = y + 24

    local btnInfo = Instance.new("TextLabel", p)
    btnInfo.Size = UDim2.new(1, -20, 0, 40)
    btnInfo.Position = UDim2.new(0, 10, 0, y)
    btnInfo.BackgroundTransparency = 1
    btnInfo.Font = Enum.Font.GothamBold
    btnInfo.TextSize = 12
    btnInfo.TextColor3 = Color3.fromRGB(255, 170, 170)
    btnInfo.TextXAlignment = Enum.TextXAlignment.Left
    btnInfo.Text = "C·∫¶N L√ÄM: B·∫¨T Auto Skills (Z, X, C, V) trong tab AutoFarm ƒë·ªÉ s·ª≠ d·ª•ng chi√™u!"
    y = y + 50
end

local function findAndFarmNPC()
    local targetNPC = nil
    local shortestDistance = FarmRadius + 1

    for _, v in ipairs(workspace:GetChildren()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
            if v.Name ~= player.Name then
                local npcHR = v:FindFirstChild("HumanoidRootPart")
                if npcHR and hrp then
                    local distance = (hrp.Position - npcHR.Position).Magnitude
                    if distance < shortestDistance then
                        shortestDistance = distance
                        targetNPC = npcHR
                    end
                end
            end
        end
    end

    if targetNPC then
        pcall(function()
            hrp.CFrame = targetNPC.CFrame * CFrame.new(0, 0, -10)
        end)

        for i = 1, 3 do
            local skillUsed = false
            for key, enabled in pairs(AutoSkillState) do
                if enabled then
                    pcall(function()
                        VirtualInputManager:SendKeyEvent(true, key, false, game)
                        task.wait(0.04)
                        VirtualInputManager:SendKeyEvent(false, key, false, game)

                        -- G·ª¨I T√çN HI·ªÜU NH·∫§P CHU·ªòT TR√ÅI GI·∫¢ KHI AUTO FARM NPC (C≈®NG C·∫¶N THI·∫æT)
                        VirtualInputManager:SendMouseButtonEvent(0, true, game) 
                        task.wait(0.01) 
                        VirtualInputManager:SendMouseButtonEvent(0, false, game)
                    end)
                    skillUsed = true
                end
            end
            if skillUsed then
               task.wait(0.3)
            else
               pcall(function()
                   VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game) 
                   task.wait(0.04)
                   VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
               end)
               task.wait(0.5)
            end
        end
        return true
    end
    return false
end

task.spawn(function()
    while true do
        if AutoFarmNPC and not isEscPressed and hrp and hrp.Parent and hrp.Parent:FindFirstChildOfClass("Humanoid").Health > 0 then
            findAndFarmNPC()
        end
        task.wait(0.5)
    end
end)

-- ================================================================= --
--                             AUTO HAKI PANEL (B·ªé LOCK CHU·ªòT)
-- ================================================================= --

local AutoHakiPanel = panels["AutoHaki"]
local HakiStatusLabel = nil
local HakiModeLabel = nil
local GuiPathBox = nil
local CurrentIntervalLabel = nil

do
    local p = AutoHakiPanel
    local y = 6

    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, 24)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(0, 170, 255)
    label.Text = "AUTO HAKI R/Q (ADAPTIVE & SPAM)"
    y = y + 30

    HakiStatusLabel = Instance.new("TextLabel", p)
    HakiStatusLabel.Size = UDim2.new(1, -10, 0, 20)
    HakiStatusLabel.Position = UDim2.new(0, 5, 0, y)
    HakiStatusLabel.BackgroundTransparency = 1
    HakiStatusLabel.Text = "Status: OFF | Mode: Adaptive | Rate: 0.15s"
    HakiStatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    HakiStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    HakiStatusLabel.Font = Enum.Font.SourceSans
    HakiStatusLabel.TextSize = 12
    y = y + 24

    local modeBtn = Instance.new("TextButton", p)
    modeBtn.Size = UDim2.new(0, 80, 0, 25)
    modeBtn.Position = UDim2.new(0, 5, 0, y)
    modeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 120)
    modeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    modeBtn.Text = "Adaptive"
    modeBtn.Font = Enum.Font.SourceSans
    modeBtn.TextSize = 14
    Instance.new("UICorner", modeBtn).CornerRadius = UDim.new(0, 6)
    HakiModeLabel = modeBtn 

    modeBtn.MouseButton1Click:Connect(function()
        currentMode = (currentMode == "Adaptive") and "Spam" or "Adaptive"
        HakiModeLabel.Text = currentMode
    end)

    local rBtn = Instance.new("TextButton", p)
    rBtn.Size = UDim2.new(0, 140, 0, 32)
    rBtn.Position = UDim2.new(0, 95, 0, y - 4)
    rBtn.Text = "R Haki: OFF"
    rBtn.Font = Enum.Font.GothamBold
    rBtn.TextSize = 14
    rBtn.TextColor3 = Color3.fromRGB(230, 230, 230)
    rBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 62)
    rBtn.BackgroundTransparency = 0.15
    rBtn.BorderSizePixel = 0
    Instance.new("UICorner", rBtn).CornerRadius = UDim.new(0, 6)

    rBtn.MouseButton1Click:Connect(function()
        AutoHakiRState = not AutoHakiRState
        rBtn.Text = "R Haki: " .. (AutoHakiRState and "ON" or "OFF")
        rBtn.BackgroundColor3 = AutoHakiRState and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(60, 60, 62)
        rBtn.BackgroundTransparency = AutoHakiRState and 0.1 or 0.15
        
        -- üî• B·ªé LOCK CHU·ªòT
        -- forceLockMouse(AutoHakiRState or AutoHakiQState)
    end)

    local qBtn = Instance.new("TextButton", p)
    qBtn.Size = UDim2.new(0, 140, 0, 32)
    qBtn.Position = UDim2.new(0, 245, 0, y - 4)
    qBtn.Text = "Q Haki: OFF"
    qBtn.Font = Enum.Font.GothamBold
    qBtn.TextSize = 14
    qBtn.TextColor3 = Color3.fromRGB(230, 230, 230)
    qBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 62)
    qBtn.BackgroundTransparency = 0.15
    qBtn.BorderSizePixel = 0
    Instance.new("UICorner", qBtn).CornerRadius = UDim.new(0, 6)

    qBtn.MouseButton1Click:Connect(function()
        AutoHakiQState = not AutoHakiQState
        qBtn.Text = "Q Haki: " .. (AutoHakiQState and "ON" or "OFF")
        qBtn.BackgroundColor3 = AutoHakiQState and Color3.fromRGB(255, 170, 0) or Color3.fromRGB(60, 60, 62)
        qBtn.BackgroundTransparency = AutoHakiQState and 0.1 or 0.15
        
        -- üî• B·ªé LOCK CHU·ªòT
        -- forceLockMouse(AutoHakiRState or AutoHakiQState)
    end)
    y = y + 36

    GuiPathBox = Instance.new("TextBox", p)
    GuiPathBox.Size = UDim2.new(1, -10, 0, 20)
    GuiPathBox.Position = UDim2.new(0, 5, 0, y)
    GuiPathBox.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    GuiPathBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    GuiPathBox.PlaceholderText = "ƒê∆∞·ªùng d·∫´n GUI Cooldown (Ex: PlayerGui.SkillGui.RButton.Bar)"
    GuiPathBox.ClearTextOnFocus = false
    GuiPathBox.Font = Enum.Font.SourceSans
    GuiPathBox.TextSize = 12
    y = y + 24

    CurrentIntervalLabel = Instance.new("TextLabel", p)
    CurrentIntervalLabel.Size = UDim2.new(1, -10, 0, 20)
    CurrentIntervalLabel.Position = UDim2.new(0, 5, 0, y)
    CurrentIntervalLabel.BackgroundTransparency = 1
    CurrentIntervalLabel.Text = "Interval: 0.150s | Success Rate: 0%"
    CurrentIntervalLabel.TextColor3 = Color3.fromRGB(150, 150, 255)
    CurrentIntervalLabel.TextSize = 12
    CurrentIntervalLabel.TextXAlignment = Enum.TextXAlignment.Left
    y = y + 24
end

local function checkCooldown(targetGUI)
    if not targetGUI or currentMode == "Spam" then return end
    
    local startVal = simpleReadGUI(targetGUI)
    if not startVal then return end
    
    local startTime = tick()
    local maxWait = 5
    
    while tick() - startTime < maxWait and not isEscPressed do 
        local currentVal = simpleReadGUI(targetGUI)
        if currentVal and math.abs(currentVal - startVal) > 0.1 then
            local cooldownStart = tick()
            while tick() - cooldownStart < maxWait and not isEscPressed do 
                local checkVal = simpleReadGUI(targetGUI)
                if checkVal and (checkVal <= 0.05 or checkVal >= 0.95) then
                    local duration = tick() - CooldownData.lastPressTime
                    if duration > 0.1 then
                        table.insert(CooldownData.lastSamples, duration)
                        if #CooldownData.lastSamples > SAMPLE_WINDOW then
                            table.remove(CooldownData.lastSamples, 1)
                        end
                        CooldownData.successCount = CooldownData.successCount + 1
                    end
                    return
                end
                task.wait(0.05)
            end
            break
        end
        task.wait(0.05)
    end
end

task.spawn(function()
    local targetGUI = nil
    
    while true do
        local isAnyHakiActive = AutoHakiRState or AutoHakiQState
        
        if isAnyHakiActive and not isEscPressed then 
            
            if not targetGUI and (GuiPathBox.Text == "" or GuiPathBox.Text == "ƒê∆∞·ªùng d·∫´n GUI Cooldown (Ex: PlayerGui.SkillGui.RButton.Bar)") then
                local autoDetected = simpleFindGUI() 
                if autoDetected then
                    targetGUI = autoDetected
                    GuiPathBox.Text = targetGUI:GetFullName()
                end
            elseif not targetGUI and GuiPathBox.Text ~= "" then
                local parts = {}
                for part in GuiPathBox.Text:gmatch("[^%.]+") do table.insert(parts, part) end
                
                local current = game
                for _, part in ipairs(parts) do
                    current = current:FindFirstChild(part)
                    if not current then break end
                end
                targetGUI = current
            end
            
            if AutoHakiRState then
                CooldownData.pressCount = CooldownData.pressCount + 1
                CooldownData.lastPressTime = tick()
                doKeyTap(Enum.KeyCode.R)
            end

            if AutoHakiQState then
                doKeyTap(Enum.KeyCode.Q)
            end
            
            local currentWaitTime = DEFAULT_INTERVAL
            if AutoHakiRState and targetGUI then
                checkCooldown(targetGUI)
                if currentMode == "Adaptive" then
                    currentWaitTime = getSmartInterval()
                end
            elseif currentMode == "Spam" then
                currentWaitTime = DEFAULT_INTERVAL
            end

            local statusText = AutoHakiRState and "R ACTIVE" or ""
            statusText = statusText .. (AutoHakiQState and (statusText=="" and "Q ACTIVE" or " & Q ACTIVE") or "")
            if statusText == "" then statusText = "ON" end

            local successRate = CooldownData.pressCount > 0 and 
                math.floor((CooldownData.successCount / CooldownData.pressCount) * 100) or 0
            
            HakiStatusLabel.Text = string.format("Status: %s | Mode: %s | Presses: %d",
                statusText, currentMode, CooldownData.pressCount)

            CurrentIntervalLabel.Text = string.format("Interval: %.3fs | Success Rate: %d%%", 
                currentWaitTime, successRate)

            task.wait(currentWaitTime)
            
        else
            if isEscPressed then
                 HakiStatusLabel.Text = "Status: ESC PRESSED (Paused)"
            else
                HakiStatusLabel.Text = "Status: OFF | Mode: " .. currentMode .. " | Rate: 0.15s"
            end
            
            task.wait(0.5)
        end
    end
end)


-- ================================================================= --
--                             FRUIT MIX PANEL (GI·ªÆ NGUY√äN)
-- ================================================================= --

local FruitMixPanel = panels["Fruit Mix"]
do
    local p = FruitMixPanel
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, y)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(0, 255, 170)
    label.Text = "AUTO DROP ITEMS (FRUIT MIX)"
    y = y + 30

    local dropBtn = Instance.new("TextButton", p)
    dropBtn.Size = UDim2.new(0, 280, 0, 32)
    dropBtn.Position = UDim2.new(0, 10, 0, y)
    dropBtn.Text = "Auto Drop Item (Th∆∞·ªùng): OFF"
    dropBtn.Font = Enum.Font.GothamBold
    dropBtn.TextSize = 14
    dropBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    dropBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 150)
    dropBtn.BackgroundTransparency = 0.15
    dropBtn.BorderSizePixel = 0
    Instance.new("UICorner", dropBtn).CornerRadius = UDim.new(0, 6)

    dropBtn.MouseButton1Click:Connect(function()
        AutoDropItem = not AutoDropItem
        dropBtn.Text = "Auto Drop Item (Th∆∞·ªùng): " .. (AutoDropItem and "ON" or "OFF")
        dropBtn.BackgroundColor3 = AutoDropItem and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(50, 50, 150)
        dropBtn.BackgroundTransparency = AutoDropItem and 0.1 or 0.15
    end)
    y = y + 40

    local dropPlusBtn = Instance.new("TextButton", p)
    dropPlusBtn.Size = UDim2.new(0, 280, 0, 32)
    dropPlusBtn.Position = UDim2.new(0, 10, 0, y)
    dropPlusBtn.Text = "Auto Drop Item (+): OFF"
    dropPlusBtn.Font = Enum.Font.GothamBold
    dropPlusBtn.TextSize = 14
    dropPlusBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    dropPlusBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 150)
    dropPlusBtn.BackgroundTransparency = 0.15
    dropPlusBtn.BorderSizePixel = 0
    Instance.new("UICorner", dropPlusBtn).CornerRadius = UDim.new(0, 6)

    dropPlusBtn.MouseButton1Click:Connect(function()
        AutoDropItemPlus = not AutoDropItemPlus
        dropPlusBtn.Text = "Auto Drop Item (+): " .. (AutoDropItemPlus and "ON" or "OFF")
        dropPlusBtn.BackgroundColor3 = AutoDropItemPlus and Color3.fromRGB(0, 200, 150) or Color3.fromRGB(50, 150, 150)
        dropPlusBtn.BackgroundTransparency = AutoDropItemPlus and 0.1 or 0.15
    end)
    y = y + 42

    local note = Instance.new("TextLabel", p)
    note.Size = UDim2.new(1, -20, 0, 40)
    note.Position = UDim2.new(0, 10, 0, y)
    note.BackgroundTransparency = 1
    note.Font = Enum.Font.Gotham
    note.TextSize = 12
    note.TextColor3 = Color3.fromRGB(255, 170, 170)
    note.TextXAlignment = Enum.TextXAlignment.Left
    note.TextWrap = true
    note.Text = "Ch·ª©c nƒÉng Auto Collect Chests (Loot H√≤m) ƒë√£ b·ªã x√≥a kh·ªèi Hub n√†y."
end

task.spawn(function()
    while true do
        if AutoDropItem and not isEscPressed then
            local itemToDrop = findDroppableItemInList(ITEM_DROP_LIST)

            if itemToDrop then
                pcall(function()
                    itemToDrop.Parent = Character
                    task.wait(0.01)

                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Backspace, false, game)
                    task.wait(0.01)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Backspace, false, game)

                    task.wait(0.1)
                end)
            end
        end
        task.wait(0.1)
    end
end)

task.spawn(function()
    while true do
        if AutoDropItemPlus and not isEscPressed then
            local itemToDrop = findDroppableItemInList(ITEM_DROP_PLUS_LIST)

            if itemToDrop then
                pcall(function()
                    itemToDrop.Parent = Character
                    task.wait(0.01)

                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Backspace, false, game)
                    task.wait(0.01)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Backspace, false, game)

                    task.wait(0.1)
                end)
            end
        end
        task.wait(0.1)
    end
end)

-- ================================================================= --
--                             SETTINGS PANEL (GI·ªÆ NGUY√äN)
-- ================================================================= --

local SettingsPanel = panels["Settings"]
do
    local p = SettingsPanel
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, y)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Text = "T√ôY CH·ªàNH N√öT ·∫®N/HI·ªÜN HUB"
    y = y + 30

    local keyLabel = Instance.new("TextLabel", p)
    keyLabel.Name = "KeyLabel"
    keyLabel.Size = UDim2.new(0, 180, 0, 24)
    keyLabel.Position = UDim2.new(0, 10, 0, y)
    keyLabel.BackgroundTransparency = 1
    local function updateKeyLabel()
        keyLabel.Text = "N√∫t hi·ªán t·∫°i: " .. tostring(Hotkey.Name)
    end
    updateKeyLabel()
    y = y + 28

    local keyInput = Instance.new("TextBox", p)
    keyInput.Size = UDim2.new(0, 180, 0, 32)
    keyInput.Position = UDim2.new(0, 10, 0, y)
    keyInput.PlaceholderText = "Nh·∫≠p ph√≠m m·ªõi (V√≠ d·ª•: F2)"
    keyInput.Text = ""
    keyInput.Font = Enum.Font.Gotham
    keyInput.TextSize = 14
    keyInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyInput.BackgroundColor3 = Color3.fromRGB(40, 40, 44)
    keyInput.BackgroundTransparency = 0.15
    keyInput.TextXAlignment = Enum.TextXAlignment.Center
    Instance.new("UICorner", keyInput).CornerRadius = UDim.new(0, 6)
    y = y + 42

    local saveBtn = Instance.new("TextButton", p)
    saveBtn.Size = UDim2.new(0, 100, 0, 32)
    saveBtn.Position = UDim2.new(0, 200, 0, y - 32)
    saveBtn.Text = "L∆ØU PH√çM"
    saveBtn.Font = Enum.Font.GothamBold
    saveBtn.TextSize = 14
    saveBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    saveBtn.BackgroundColor3 = Color3.fromRGB(80, 150, 80)
    saveBtn.BackgroundTransparency = 0.15
    Instance.new("UICorner", saveBtn).CornerRadius = UDim.new(0, 6)

    saveBtn.MouseButton1Click:Connect(function()
        local newKeyName = keyInput.Text:upper()
        local success, newKey = pcall(function() return Enum.KeyCode[newKeyName] end)

        if success and newKey then
            Hotkey = newKey
            updateKeyLabel()
            keyInput.Text = ""
            print("Hotkey ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi th√†nh: " .. tostring(Hotkey.Name))
        else
            keyInput.Text = "Ph√≠m kh√¥ng h·ª£p l·ªá!"
            warn("Kh√¥ng th·ªÉ thay ƒë·ªïi Hotkey: Ph√≠m kh√¥ng h·ª£p l·ªá.")
            task.wait(1)
            keyInput.Text = ""
        end
    end)
    y = y + 50

    local note = Instance.new("TextLabel", p)
    note.Size = UDim2.new(1, -20, 0, 40)
    note.Position = UDim2.new(0, 10, 0, y)
    note.BackgroundTransparency = 1
    note.Font = Enum.Font.Gotham
    note.TextSize = 12
    note.TextColor3 = Color3.fromRGB(255, 170, 170)
    note.TextXAlignment = Enum.TextXAlignment.Left
    note.TextWrap = true
    note.Text = "Ch·ªâ d√πng ph√≠m ƒë∆°n (v√≠ d·ª•: F2, R, P, LeftControl, RightControl, E...)."
    y = y + 50
end

local foot=Instance.new("TextLabel")
foot.Size=UDim2.new(1,0,0,16)
foot.Position=UDim2.new(0,0,1,-16)
foot.BackgroundTransparency=1
foot.Font = Enum.Font.Gotham
foot.TextSize = 11
foot.TextColor3 = Color3.fromRGB(150,150,150)
foot.Text="NTBA ‚Ä¢ Farm Hub v21.2.6 (Fixed Z,X,C,V Straight Aim)" 
foot.Parent=Main

print("NTBA Farm Hub v21.2.6 - Fixed: B·ªè Lock Chu·ªôt Haki v√† Z,X,C,V bay th·∫≥ng.")
