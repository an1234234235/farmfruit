local RF_RareDevilfruit = {
    "Smoke", "Sand", "Rumble", "Quake", "Phoenix", "Ope", "Magma", "Light",
    "Hollow", "Alice", "Gas", "Flare", "Dark", "Chilly", "Candy",
    "Plasma", "Gravity", "Vampire", "Venom", "Snow",
    "Shadow", "Control", "Dough", "Leopard", "Dragon", "Kilo", "Buddha",
    "Luck",
}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer
local Character = player.Character or player.CharacterAdded:Wait()
local hrp = Character:WaitForChild("HumanoidRootPart")
local Backpack = player:WaitForChild("Backpack")

local AutoFarmNPC = false
local FarmRadius = 150 
local AutoSkillState={Z=false,X=false,C=false,V=false} 
local AutoHakiState=false 
local AutoDropItem = false 

local AutoFruitState = {} 
for _, fruitName in ipairs(RF_RareDevilfruit) do
    AutoFruitState[fruitName] = false
end
local PICKUP_RANGE = 50 
local billboardGuiMap = {}

local ITEM_DROP_LIST = {
    ["Apple"] = true,
    ["Cantaloup"] = true, 
    ["Cantaloupe"] = true, 
    ["Banana"] = true,
    ["Green Apple"] = true,
    ["Coconut"] = true,
    ["Pumpkin"] = true,
    ["Prickly Pear"] = true,
    ["Melon"] = true,
}

local function findDroppableItemInList()
    for _, item in ipairs(Backpack:GetChildren()) do
        if (item:IsA("Tool") or item:IsA("HopperBin")) and ITEM_DROP_LIST[item.Name] then 
            return item
        end
    end
    return nil
end

local function createBillboardGuiForFruit(model, fruitName, offsetY)
    if model:FindFirstChild("Head") then
        if not billboardGuiMap[model] then billboardGuiMap[model] = {} end
        
        if billboardGuiMap[model][fruitName] then
            billboardGuiMap[model][fruitName]:Destroy()
        end
        
        local billboardGui = Instance.new("BillboardGui")
        billboardGui.Adornee = model.Head
        billboardGui.Parent = model.Head
        billboardGui.Size = UDim2.new(0, 200, 0, 50)
        billboardGui.StudsOffset = Vector3.new(0, offsetY, 0)
        
        local textLabel = Instance.new("TextLabel")
        textLabel.Parent = billboardGui
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Text = fruitName .. "!"
        textLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextScaled = true
        textLabel.Font = Enum.Font.GothamBold
        
        billboardGuiMap[model][fruitName] = billboardGui
    end
end

local function removeBillboardGuiForFruit(model, fruitName)
    if billboardGuiMap[model] and billboardGuiMap[model][fruitName] then
        billboardGuiMap[model][fruitName]:Destroy()
        billboardGuiMap[model][fruitName] = nil
    end
end

local function pickUpFruit(v, fruitName, pickupRemote)
    -- Sử dụng Coroutine.wrap để thực thi nhanh chóng, tránh bị chặn
    coroutine.wrap(function()
        if hrp and hrp.Parent and v.PrimaryPart then
            local distance = (hrp.Position - v.PrimaryPart.Position).Magnitude
            
            if distance < PICKUP_RANGE then
                
                print("!!! Teleporting to fruit: " .. fruitName .. " !!!")
                hrp.CFrame = v.PrimaryPart.CFrame * CFrame.new(0, 0, -2) 
                task.wait(0.05)
                
                if pickupRemote and pickupRemote:IsA("RemoteEvent") then
                    print("!!! Auto-Picked up: " .. fruitName .. " bằng RemoteEvent FireServer !!!")
                    pcall(function()
                        pickupRemote:FireServer()
                    end)
                else
                    print("!!! Auto-Picked up: " .. fruitName .. " bằng Touch (Dự phòng) !!!")
                    -- Touch pickup (chạm) thường được thực hiện sau khi tele
                end
                
                task.wait(1.5) 
                return 
            end
        end
    end)()
end

local function checkFruitsInWorkspace()
    local offsetY = 3 
    for i, v in pairs(workspace:GetChildren()) do  
        if v:IsA("Model") and v:FindFirstChild("PrimaryPart") then 
            for _, fruitName in ipairs(RF_RareDevilfruit) do
                local fruitInstance = v:FindFirstChild(fruitName .. " Fruit") or v:FindFirstChild("Lock Fruit")
                
                if fruitInstance and v.PrimaryPart then
                    createBillboardGuiForFruit(v, fruitName, offsetY)
                    offsetY = offsetY + 1
                    
                    if AutoFruitState[fruitName] and hrp and hrp.Parent and v.PrimaryPart then
                        
                        local pickupRemote = fruitInstance:FindFirstChild("ClickSelector") and fruitInstance.ClickSelector:FindFirstChild("Relay") and fruitInstance.ClickSelector.Relay:FindFirstChild("Pickup")
                        if not pickupRemote then
                            pickupRemote = fruitInstance:FindFirstChild("ClickSelector") and fruitInstance.ClickSelector:FindFirstChild("Pickup")
                        end

                        if pickupRemote and pickupRemote:IsA("RemoteEvent") then
                            pickUpFruit(v, fruitName, pickupRemote)
                        end
                    end
                else
                    removeBillboardGuiForFruit(v, fruitName)
                end
            end
        end
    end
end

local function checkFruitsInPlayers()
    local offsetY = 3
    for _, p in pairs(Players:GetChildren()) do  
        if p.Character and p.Character:FindFirstChild("Head") and p ~= player then
            local char = p.Character
            for _, fruitName in ipairs(RF_RareDevilfruit) do
                local fruitInBackpack = p.Backpack:FindFirstChild(fruitName .. " Fruit")
                local fruitEquipped = char:FindFirstChild(fruitName .. " Fruit")
                
                if fruitInBackpack or fruitEquipped then
                    createBillboardGuiForFruit(char, fruitName, offsetY)
                    offsetY = offsetY + 1 
                else
                    removeBillboardGuiForFruit(char, fruitName)
                end
            end
        end
    end
end

-- Vòng lặp tìm trái cây riêng
task.spawn(function()
    while true do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            hrp = player.Character.HumanoidRootPart
            checkFruitsInWorkspace()
            checkFruitsInPlayers()
        end
        task.wait(0.5) 
    end
end)


pcall(function()
    if player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("FruitHubUI") then
        player.PlayerGui.FruitHubUI:Destroy()
    end
end)

local PlayerGui = player:WaitForChild("PlayerGui", 5) 
if not PlayerGui then return end 

-- Tạo hàm Switch Toggle (ĐÃ TỐI ƯU HÓA)
local function createToggleSwitch(parent, initialPos, onClickCallback, initialState, enabledColor, disabledColor, toggleSize)
    toggleSize = toggleSize or UDim2.new(0, 44, 0, 24)
    local Switch = Instance.new("TextButton")
    Switch.Size = toggleSize
    Switch.Position = initialPos
    Switch.BackgroundColor3 = initialState and enabledColor or disabledColor
    Switch.BackgroundTransparency = 0.5 
    Switch.Text = ""
    Switch.BorderSizePixel = 0
    Switch.Parent = parent
    Instance.new("UICorner", Switch).CornerRadius = UDim.new(0.5, 0)
    
    local Slider = Instance.new("Frame")
    Slider.Size = UDim2.new(0, 18, 0, 18)
    Slider.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    Slider.BorderSizePixel = 0
    Slider.Parent = Switch
    Instance.new("UICorner", Slider).CornerRadius = UDim.new(0.5, 0)
    
    local enabledPos = UDim2.new(1, -21, 0.5, -9) 
    local disabledPos = UDim2.new(0, 3, 0.5, -9)
    Slider.Position = initialState and enabledPos or disabledPos

    local state = initialState
    
    Switch.MouseButton1Click:Connect(function()
        state = not state
        
        -- Gọi callback trước để cập nhật biến Lua
        onClickCallback(state) 
        
        -- Sử dụng TweenService an toàn hơn
        Switch:TweenBackgroundColor(
            Enum.EasingDirection.Out, 
            Enum.EasingStyle.Quad, 
            0.2, 
            false, 
            state and enabledColor or disabledColor
        )
        Slider:TweenPosition(
            state and enabledPos or disabledPos, 
            Enum.EasingDirection.Out, 
            Enum.EasingStyle.Quad, 
            0.2, 
            true
        )
    end)
    return Switch, Slider
end

-- ===== PHẦN UI (Kích thước mới và trong suốt) =====
local MAIN_W, MAIN_H = 640, 380 
local Sidebar_W = 140
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FruitHubUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Main = Instance.new("Frame")
Main.Name = "Main"
Main.Size = UDim2.new(0, MAIN_W, 0, MAIN_H)
Main.Position = UDim2.new(0.5, -MAIN_W/2, 0.12, 0) 
Main.BackgroundColor3 = Color3.fromRGB(24,24,28)
Main.BackgroundTransparency = 0.3 
Main.BorderSizePixel = 0
Main.Parent = ScreenGui
Instance.new("UICorner", Main).CornerRadius = UDim.new(0,12)

local shadow = Instance.new("UIStroke", Main)
shadow.Color = Color3.fromRGB(85, 170, 255)
shadow.Thickness = 2
shadow.Transparency = 0.6

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1,0,0,32) 
TitleBar.Position = UDim2.new(0,0,0,0)
TitleBar.BackgroundColor3 = Color3.fromRGB(32,32,36)
TitleBar.BackgroundTransparency = 0.4 
TitleBar.BorderSizePixel = 0
TitleBar.Parent = Main
Instance.new("UICorner", TitleBar).CornerRadius = UDim.new(0,12)

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(0.6,-10,1,0)
TitleLabel.Position = UDim2.new(0,10,0,0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "NTBA • Fruit Hub"
TitleLabel.TextSize = 15
TitleLabel.TextColor3 = Color3.fromRGB(170, 255, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local AuthorLabel = Instance.new("TextLabel")
AuthorLabel.Size = UDim2.new(0.3,-10,1,0)
AuthorLabel.Position = UDim2.new(0.7,10,0,0)
AuthorLabel.BackgroundTransparency = 1
AuthorLabel.Font = Enum.Font.Gotham
AuthorLabel.Text = "Author: NTBA"
AuthorLabel.TextSize = 12
AuthorLabel.TextColor3 = Color3.fromRGB(160,160,160)
AuthorLabel.TextXAlignment = Enum.TextXAlignment.Right
AuthorLabel.Parent = TitleBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0,30,0,24) 
CloseBtn.Position = UDim2.new(1,-38,0,4)
CloseBtn.BackgroundColor3 = Color3.fromRGB(180,60,60)
CloseBtn.Text = "X"
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 13
CloseBtn.TextColor3 = Color3.fromRGB(255,255,255)
CloseBtn.BorderSizePixel = 0
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0,6)
CloseBtn.Parent = TitleBar
CloseBtn.MouseButton1Click:Connect(function() 
    ScreenGui:Destroy() 
    script:Destroy() 
end)

do
    local dragging = false
    local dragStart, startPos
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 then
            dragging=true
            dragStart=input.Position
            startPos=Main.Position
            input.Changed:Connect(function()
                if input.UserInputState==Enum.UserInputState.End then dragging=false end
            end)
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
            local delta=input.Position - dragStart
            Main.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X,startPos.Y.Scale,startPos.Y.Offset+delta.Y)
        end
    end)
end

local Hotkey=Enum.KeyCode.RightControl
local HubVisible=true
UserInputService.InputBegan:Connect(function(input,gpe)
    if not gpe and input.KeyCode==Hotkey then
        HubVisible=not HubVisible
        ScreenGui.Enabled=HubVisible
    end
end)

local Sidebar = Instance.new("Frame")
Sidebar.Size = UDim2.new(0,Sidebar_W,1,-32)
Sidebar.Position = UDim2.new(0,0,0,32)
Sidebar.BackgroundColor3 = Color3.fromRGB(36,36,38)
Sidebar.BackgroundTransparency = 0.4 
Sidebar.BorderSizePixel = 0
Sidebar.Parent = Main
Instance.new("UICorner", Sidebar).CornerRadius = UDim.new(0,10)

local SidebarLayout = Instance.new("UIListLayout", Sidebar)
SidebarLayout.Padding = UDim.new(0,6)
SidebarLayout.SortOrder = Enum.SortOrder.LayoutOrder
SidebarLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
SidebarLayout.VerticalAlignment = Enum.VerticalAlignment.Top

local tabs = {"AutoFarm","AutoNPC","AutoHaki","Fruit","Drop Fruit Mix","Settings"}
local tabButtons, panels = {}, {}

local Panel_X_Start = Sidebar_W + 10 
local Panel_Y_Start = 32 + 10      
local Panel_W = MAIN_W - Sidebar_W - 20 
local Panel_H = MAIN_H - 32 - 20        

for i,name in ipairs(tabs) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-10,0,32)
    btn.BackgroundColor3 = Color3.fromRGB(44,44,46)
    btn.BackgroundTransparency = 0.5 
    btn.BorderSizePixel = 0
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Text = name
    btn.Parent = Sidebar
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
    btn.LayoutOrder = i
    tabButtons[name] = btn

    local panel = Instance.new("Frame")
    panel.Name = name .. "Panel"
    panel.Size = UDim2.new(0, Panel_W, 0, Panel_H) 
    panel.Position = UDim2.new(0, Panel_X_Start, 0, Panel_Y_Start) 
    panel.BackgroundTransparency = 1
    panel.Visible = false
    panel.Parent = Main
    panels[name] = panel
end

panels["AutoFarm"].Visible = true
tabButtons["AutoFarm"].BackgroundTransparency = 0.2
tabButtons["AutoFarm"].BackgroundColor3 = Color3.fromRGB(60,60,62)

for name, btn in pairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        for k,v in pairs(tabButtons) do 
            v.BackgroundColor3 = Color3.fromRGB(44,44,46) 
            v.BackgroundTransparency = 0.5
        end
        for _,p in pairs(panels) do p.Visible = false end
        btn.BackgroundColor3 = Color3.fromRGB(60,60,62)
        btn.BackgroundTransparency = 0.2
        panels[name].Visible = true
    end)
end

-- ======================================================
-- 1. AUTO FARM (SKILLS)
-- ======================================================
do
    local p = panels["AutoFarm"] 
    local y=6
    local label=Instance.new("TextLabel",p)
    label.Size=UDim2.new(1,0,0,24)
    label.Position=UDim2.new(0,0,0,y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(220,220,220)
    label.Text="Auto Skills (spam keys)"
    y=y+30
    
    local SkillContainer = Instance.new("Frame", p)
    SkillContainer.Size = UDim2.new(1,-10,0,30)
    SkillContainer.Position = UDim2.new(0,5,0,y)
    SkillContainer.BackgroundTransparency = 1
    
    local keys = {"Z","X","C","V"}
    for i,key in ipairs(keys) do
        local keyLabel = Instance.new("TextLabel", SkillContainer)
        keyLabel.Text = key
        keyLabel.Size = UDim2.new(0, 20, 0, 24)
        keyLabel.Position = UDim2.new(0, 0 + (i-1)*70, 0, 0)
        keyLabel.BackgroundTransparency = 1
        keyLabel.Font = Enum.Font.GothamBold
        keyLabel.TextSize = 14
        keyLabel.TextColor3 = Color3.fromRGB(255, 170, 255)

        createToggleSwitch(
            SkillContainer, 
            UDim2.new(0, 25 + (i-1)*70, 0, 0),
            function(state)
                AutoSkillState[key] = state
            end, 
            false, 
            Color3.fromRGB(0,170,255), 
            Color3.fromRGB(60,60,62),
            UDim2.new(0, 44, 0, 24)
        )
    end
end
task.spawn(function()
    while true do
        task.wait(0.18)
        for key,enabled in pairs(AutoSkillState) do
            if enabled and not AutoFarmNPC then 
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true,key,false,game)
                    task.wait(0.04)
                    VirtualInputManager:SendKeyEvent(false,key,false,game)
                end)
            end
        end
    end
end)

-- ======================================================
-- 2. AUTO NPC
-- ======================================================
local AutoNPCPanel = panels["AutoNPC"]
do 
    local p = AutoNPCPanel 
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, 24)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 170, 0)
    label.Text = "AUTO FARM NPC (Tự động đánh quái)"
    y = y + 30

    local lblMaster = Instance.new("TextLabel", p)
    lblMaster.Size = UDim2.new(0, 150, 0, 24)
    lblMaster.Position = UDim2.new(0, 10, 0, y)
    lblMaster.BackgroundTransparency = 1
    lblMaster.Font = Enum.Font.GothamBold
    lblMaster.TextSize = 14
    lblMaster.TextColor3 = Color3.fromRGB(255, 255, 255)
    lblMaster.TextXAlignment = Enum.TextXAlignment.Left
    lblMaster.Text = "Auto Farm NPC"

    createToggleSwitch(
        p, 
        UDim2.new(0, 170, 0, y),
        function(state)
            AutoFarmNPC = state
        end, 
        AutoFarmNPC, 
        Color3.fromRGB(0, 150, 255), 
        Color3.fromRGB(150, 50, 50)
    )

    y = y + 40

    local lblRange = Instance.new("TextLabel", p)
    lblRange.Size = UDim2.new(0, 250, 0, 20)
    lblRange.Position = UDim2.new(0, 10, 0, y)
    lblRange.BackgroundTransparency = 1
    lblRange.Font = Enum.Font.Gotham
    lblRange.TextSize = 13
    lblRange.TextColor3 = Color3.fromRGB(200, 200, 200)
    lblRange.Text = "Phạm vi tìm kiếm: " .. FarmRadius .. " studs (Mặc định)"
    lblRange.TextXAlignment = Enum.TextXAlignment.Left
    y = y + 26
    
    local btnInfo = Instance.new("TextLabel", p)
    btnInfo.Size = UDim2.new(1, -20, 0, 40)
    btnInfo.Position = UDim2.new(0, 10, 0, y)
    btnInfo.BackgroundTransparency = 1
    btnInfo.Font = Enum.Font.GothamBold
    btnInfo.TextSize = 12
    btnInfo.TextColor3 = Color3.fromRGB(255, 170, 170)
    btnInfo.TextXAlignment = Enum.TextXAlignment.Left
    btnInfo.Text = "LƯU Ý: Phải BẬT Auto Skills (Z, X, C, V) trong tab AutoFarm để auto farm sử dụng chiêu!"
    y = y + 50
end

local function findAndFarmNPC()
    local targetNPC = nil
    local shortestDistance = FarmRadius + 1

    for _, v in ipairs(workspace:GetChildren()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
            if v.Name ~= player.Name and not v:FindFirstChild("LockFruit") then 
                local npcHR = v:FindFirstChild("HumanoidRootPart")
                if npcHR and hrp then
                    local distance = (hrp.Position - npcHR.Position).Magnitude
                    if distance < shortestDistance then
                        shortestDistance = distance
                        targetNPC = npcHR
                    end
                end
            end
        end
    end

    if targetNPC then
        pcall(function()
            local direction = (hrp.Position - targetNPC.Position).Unit
            hrp.CFrame = targetNPC.CFrame * CFrame.new(0, 0, -10) 
        end)
        
        for i = 1, 3 do 
            for key, enabled in pairs(AutoSkillState) do
                if enabled then
                    pcall(function()
                        VirtualInputManager:SendKeyEvent(true, key, false, game)
                        task.wait(0.04)
                        VirtualInputManager:SendKeyEvent(false, key, false, game)
                    end)
                end
            end
            task.wait(0.3)
        end
        return true 
    end
    return false
end

task.spawn(function()
    while true do
        if AutoFarmNPC and hrp and hrp.Parent and hrp.Parent:FindFirstChildOfClass("Humanoid").Health > 0 then
            findAndFarmNPC()
        end
        task.wait(0.5) 
    end
end)

-- ======================================================
-- 3. AUTO HAKI
-- ======================================================
local AutoHakiPanel = panels["AutoHaki"]
do
    local p = AutoHakiPanel 
    local y = 6
    local lbl=Instance.new("TextLabel",p)
    lbl.Size=UDim2.new(1,0,0,24)
    lbl.Position=UDim2.new(0,0,0,y)
    lbl.BackgroundTransparency=1
    lbl.Font = Enum.Font.GothamBold
    lbl.TextSize = 14
    lbl.TextColor3 = Color3.fromRGB(220,220,220)
    lbl.Text="Auto Haki (spam R)"
    y = y + 30
    
    local lblToggle = Instance.new("TextLabel", p)
    lblToggle.Size = UDim2.new(0, 100, 0, 24)
    lblToggle.Position = UDim2.new(0, 10, 0, y)
    lblToggle.BackgroundTransparency = 1
    lblToggle.Font = Enum.Font.GothamBold
    lblToggle.TextSize = 14
    lblToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    lblToggle.TextXAlignment = Enum.TextXAlignment.Left
    lblToggle.Text = "Kích hoạt Haki"

    createToggleSwitch(
        p, 
        UDim2.new(0, 120, 0, y),
        function(state)
            AutoHakiState = state
        end, 
        AutoHakiState, 
        Color3.fromRGB(0,170,255), 
        Color3.fromRGB(60,60,62)
    )
end

task.spawn(function()
    while true do
        if AutoHakiState then
            pcall(function()
                VirtualInputManager:SendKeyEvent(true,"R",false,game)
                task.wait(0.06)
                VirtualInputManager:SendKeyEvent(false,"R",false,game)
            end)
        end
        task.wait(6.5)
    end
end)

-- ======================================================
-- 4. FRUIT FINDER/PICKUP
-- ======================================================
local FruitPanel = panels["Fruit"]
do
    local p = FruitPanel
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, 24)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 255, 0) 
    label.Text = "AUTO FRUIT PICKUP (RemoteEvent)"
    y = y + 30
    
    local scrollFrame = Instance.new("ScrollingFrame", p)
    scrollFrame.Size = UDim2.new(1, 0, 1, -y)
    scrollFrame.Position = UDim2.new(0, 0, 0, y)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0) 
    
    local listLayout = Instance.new("UIListLayout", scrollFrame)
    listLayout.Padding = UDim.new(0, 6)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    listLayout.VerticalAlignment = Enum.VerticalAlignment.Top
    
    local buttonHeight = 32
    local spacing = 10
    local fruitCount = 0

    for i, fruitName in ipairs(RF_RareDevilfruit) do
        local container = Instance.new("Frame", scrollFrame)
        container.Size = UDim2.new(1, -10, 0, buttonHeight)
        container.BackgroundTransparency = 1
        container.LayoutOrder = i

        local nameLabel = Instance.new("TextLabel", container)
        nameLabel.Size = UDim2.new(0, 120, 1, 0)
        nameLabel.Position = UDim2.new(0, 0, 0, 0)
        nameLabel.Text = fruitName
        nameLabel.BackgroundTransparency = 1
        nameLabel.Font = Enum.Font.GothamBold
        nameLabel.TextSize = 14
        nameLabel.TextColor3 = Color3.fromRGB(230, 230, 230)
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left

        createToggleSwitch(
            container, 
            UDim2.new(0, 130, 0, 4),
            function(state)
                AutoFruitState[fruitName] = state
            end, 
            AutoFruitState[fruitName], 
            Color3.fromRGB(255, 170, 0), 
            Color3.fromRGB(60, 60, 62),
            UDim2.new(0, 44, 0, 24)
        )
        fruitCount = fruitCount + 1
    end
    
    local totalHeight = fruitCount * (buttonHeight + spacing) + spacing 
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, totalHeight)

end

-- ======================================================
-- 5. AUTO DROP (Đã đổi tên)
-- ======================================================
local DropPanel = panels["Drop Fruit Mix"]
do
    local p = DropPanel
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, 24)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(0, 255, 170) 
    label.Text = "AUTO DROP ITEMS"
    y = y + 30

    local lblToggle = Instance.new("TextLabel", p)
    lblToggle.Size = UDim2.new(0, 120, 0, 24)
    lblToggle.Position = UDim2.new(0, 10, 0, y)
    lblToggle.BackgroundTransparency = 1
    lblToggle.Font = Enum.Font.GothamBold
    lblToggle.TextSize = 14
    lblToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    lblToggle.TextXAlignment = Enum.TextXAlignment.Left
    lblToggle.Text = "Tự động Drop"
    
    createToggleSwitch(
        p, 
        UDim2.new(0, 130, 0, y),
        function(state)
            AutoDropItem = state
        end, 
        AutoDropItem, 
        Color3.fromRGB(0, 170, 255), 
        Color3.fromRGB(50, 50, 150)
    )

    y = y + 40
    
    local note = Instance.new("TextLabel", p)
    note.Size = UDim2.new(1, -20, 0, 80)
    note.Position = UDim2.new(0, 10, 0, y)
    note.BackgroundTransparency = 1
    note.Font = Enum.Font.Gotham
    note.TextSize = 12
    note.TextColor3 = Color3.fromRGB(255, 170, 170)
    note.TextXAlignment = Enum.TextXAlignment.Left
    note.TextWrap = true
    note.Text = "Chức năng này sẽ tìm và drop BẤT KỲ Tool/Fruit nào trong túi đồ có tên: Apple, Cantaloup, Cantaloupe, Banana, Green Apple, Coconut, Pumpkin, Prickly Pear, Melon. Cơ chế: Ép trang bị -> Backspace."
    y = y + 90 
end

task.spawn(function()
    while true do
        if AutoDropItem then
            local itemToDrop = findDroppableItemInList()
            
            if itemToDrop then
                pcall(function()
                    itemToDrop.Parent = Character 
                    task.wait(0.01) 
                    
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Backspace, false, game)
                    task.wait(0.01) 
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Backspace, false, game)
                    
                    task.wait(0.1) 
                end)
            end
        end
        task.wait(0.1) 
    end
end)

-- ======================================================
-- 6. SETTINGS (Not yet implemented)
-- ======================================================
local SettingsPanel = panels["Settings"]
do
    local p = SettingsPanel
    local y = 6
    local label = Instance.new("TextLabel", p)
    label.Size = UDim2.new(1, 0, 0, 26)
    label.Position = UDim2.new(0, 0, 0, y)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Text = "Các Thiết Lập Khác"
    y = y + 30
    
    local note = Instance.new("TextLabel", p)
    note.Size = UDim2.new(1, -20, 0, 40)
    note.Position = UDim2.new(0, 10, 0, y)
    note.BackgroundTransparency = 1
    note.Font = Enum.Font.Gotham
    note.TextSize = 12
    note.TextColor3 = Color3.fromRGB(170, 255, 170)
    note.TextXAlignment = Enum.TextXAlignment.Left
    note.TextWrap = true
    note.Text = "Hiện chưa có thiết lập mở rộng nào."
    y = y + 50
end


local foot=Instance.new("TextLabel")
foot.Size=UDim2.new(1,0,0,18)
foot.Position=UDim2.new(0,0,1,-18)
foot.BackgroundTransparency=1
foot.Font = Enum.Font.Gotham
foot.TextSize = 11
foot.TextColor3 = Color3.fromRGB(150,150,150)
foot.Text="NTBA • Fruit Hub v16.7 (Toggle Switch Fixed)"
foot.Parent=Main

print("NTBA Fruit Hub v16.7 - Toggle Switch UI/Logic Fixed. 'Drop' renamed to 'Drop Fruit Mix'.")
