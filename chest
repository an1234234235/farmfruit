-- ü™Ñ Auto Farm Chest NTBA (B·∫£n H·ªìng üå∏ + TƒÉng T·ªëc + Gi·∫£m Lag)
-- ‚ú® UI m√†u h·ªìng, d·ªÖ nh√¨n, n·ªïi b·∫≠t
-- ‚ö° Teleport m·ªÅm nhanh (3‚Äì5 b∆∞·ªõc, 0.01‚Äì0.03s)
-- ‚è© Gi·∫£m delay gi·ªØa chest ƒë·ªÉ farm nhanh h∆°n
-- üåê Auto server hop khi h·∫øt chest
-- üßº Xo√° UI + script sau khi farm xong

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local workspace = workspace
local Lighting = game:GetService("Lighting")

-- üßπ T·∫ÆT LIGHTING & HI·ªÜU ·ª®NG ƒë·ªÉ gi·∫£m lag ‚ö°
Lighting.GlobalShadows = false
Lighting.FogEnd = 1e10

local atmosphere = Lighting:FindFirstChildOfClass("Atmosphere")
if atmosphere then atmosphere:Destroy() end

for _, v in pairs(Lighting:GetChildren()) do
	if v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("ColorCorrectionEffect") or v:IsA("SunRaysEffect") then
		v:Destroy()
	end
end

pcall(function()
	sethiddenproperty(workspace, "InterpolationThrottling", Enum.InterpolationThrottlingMode.Disabled)
end)

-- ====== C·∫•u h√¨nh ======
local AUTO_ON = true
local SCAN_RANGE = 3000000
local MAX_FAIL = 8
local SERVERHOP_URL = "https://pastebin.com/raw/Ru4UQDpN"

local chestCount = 0
local failCount = 0
local serverHopExecuted = false

local function getScanDelay()
	return math.random(40, 80) / 100 -- 0.4 ‚Äì 0.8s
end

-- ====== UI ======
local function createUI()
	if game:GetService("CoreGui"):FindFirstChild("NTBAHubUI") then
		return game:GetService("CoreGui").NTBAHubUI
	end

	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "NTBAHubUI"
	screenGui.ResetOnSpawn = false
	screenGui.Parent = game:GetService("CoreGui")

	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(0, 360, 0, 170)
	frame.Position = UDim2.new(0.5, -180, 0.5, -85)
	frame.BackgroundColor3 = Color3.fromRGB(255, 105, 180)  -- üå∏ H·ªìng ƒë·∫≠m (hot pink)
	frame.BackgroundTransparency = 0.02
	frame.BorderSizePixel = 0
	frame.Parent = screenGui
	Instance.new("UICorner", frame).CornerRadius = UDim.new(0,20)

	local title = Instance.new("TextLabel", frame)
	title.Size = UDim2.new(1, -20, 0, 30)
	title.Position = UDim2.new(0,10,0,8)
	title.BackgroundTransparency = 1
	title.Font = Enum.Font.GothamBold
	title.TextSize = 22
	title.TextColor3 = Color3.new(1,1,1) -- tr·∫Øng ƒë·ªÉ n·ªïi tr√™n n·ªÅn h·ªìng
	title.Text = "üåü NTBA Chest"

	local beriLabel = Instance.new("TextLabel", frame)
	beriLabel.Size = UDim2.new(1, -20, 0, 28)
	beriLabel.Position = UDim2.new(0,10,0,48)
	beriLabel.BackgroundTransparency = 1
	beriLabel.Font = Enum.Font.Gotham
	beriLabel.TextSize = 18
	beriLabel.TextXAlignment = Enum.TextXAlignment.Left
	beriLabel.TextColor3 = Color3.fromRGB(255,255,255)
	beriLabel.Text = "Beri: 0"

	local chestLabel = Instance.new("TextLabel", frame)
	chestLabel.Size = UDim2.new(1, -20, 0, 28)
	chestLabel.Position = UDim2.new(0,10,0,80)
	chestLabel.BackgroundTransparency = 1
	chestLabel.Font = Enum.Font.Gotham
	chestLabel.TextSize = 18
	chestLabel.TextXAlignment = Enum.TextXAlignment.Left
	chestLabel.TextColor3 = Color3.fromRGB(240,240,240)
	chestLabel.Text = "Chest ƒë√£ l·∫•y: 0"

	local statusLabel = Instance.new("TextLabel", frame)
	statusLabel.Size = UDim2.new(1, -20, 0, 22)
	statusLabel.Position = UDim2.new(0,10,0,115)
	statusLabel.BackgroundTransparency = 1
	statusLabel.Font = Enum.Font.Gotham
	statusLabel.TextSize = 15
	statusLabel.TextXAlignment = Enum.TextXAlignment.Left
	statusLabel.TextColor3 = Color3.fromRGB(240,240,240)
	statusLabel.Text = "Status: Idle"

	return beriLabel, chestLabel, statusLabel, screenGui
end

local beriLabel, chestLabel, statusLabel, uiRoot = createUI()

-- ====== Helper ======
local function getHRP()
	local char = LocalPlayer.Character
	if char and char:FindFirstChild("HumanoidRootPart") then
		return char.HumanoidRootPart
	end
	return nil
end

-- ‚ö° Teleport m·ªÅm 3‚Äì5 b∆∞·ªõc, delay 0.01‚Äì0.03s
local function softTpTo(targetPos)
	local hrp = getHRP()
	if not hrp then return end

	local startPos = hrp.Position
	local steps = math.random(3, 5)

	for i = 1, steps do
		local alpha = i / steps
		local stepPos = startPos:Lerp(targetPos + Vector3.new(0,3,0), alpha)
		stepPos = stepPos + Vector3.new(math.random(-2,2), 0, math.random(-2,2))
		hrp.CFrame = CFrame.new(stepPos)
		task.wait(math.random(1, 3)/100) -- 0.01‚Äì0.03s m·ªói b∆∞·ªõc
	end
end

-- üß∞ T√¨m chest g·∫ßn
local function findChests()
	local chests = {}
	local chestFolder = workspace:FindFirstChild("Chests")
	local hrp = getHRP()
	if not chestFolder or not hrp then return chests end

	for _, m in pairs(chestFolder:GetChildren()) do
		if m:IsA("Model") and tostring(m.Name):lower():find("chest") then
			local pos
			if m.PrimaryPart then
				pos = m.PrimaryPart.Position
			else
				for _, p in pairs(m:GetChildren()) do
					if p:IsA("BasePart") then pos = p.Position break end
				end
			end
			if pos and (hrp.Position - pos).Magnitude <= SCAN_RANGE then
				table.insert(chests, pos)
			end
		end
	end
	return chests
end

-- üåê Server hop
local function serverHop()
	if serverHopExecuted then return end
	serverHopExecuted = true
	statusLabel.Text = "Status: Hopping server..."
	task.spawn(function()
		task.wait(0.6)
		local ok, err = pcall(function()
			local s = game:HttpGet(SERVERHOP_URL)
			loadstring(s)()
		end)
		if not ok then warn("Server hop failed:", err) end
	end)
end

-- üß† Auto c·∫≠p nh·∫≠t Beri
task.spawn(function()
	local userData = workspace:FindFirstChild("UserData") or workspace:WaitForChild("UserData",5)
	if not userData then return end
	local folder = userData:FindFirstChild("User_"..LocalPlayer.UserId) or userData:FindFirstChild(LocalPlayer.Name)
	if not folder then return end
	local data = folder:FindFirstChild("Data") or folder:WaitForChild("Data",5)
	if not data then return end
	local beriVal = data:FindFirstChild("Beri")
	if not beriVal then return end

	local lastBeri = beriVal.Value
	beriLabel.Text = "Beri: "..tostring(lastBeri)

	beriVal:GetPropertyChangedSignal("Value"):Connect(function()
		local diff = beriVal.Value - lastBeri
		if diff > 0 then
			chestCount += 1
			chestLabel.Text = "Chest ƒë√£ l·∫•y: "..tostring(chestCount)
			statusLabel.Text = "Status: Picked chest!"
		end
		lastBeri = beriVal.Value
		beriLabel.Text = "Beri: "..tostring(beriVal.Value)
	end)
end)

-- üßº Xo√° UI + script sau khi xong
local function cleanupAndExit()
	statusLabel.Text = "Status: ƒê√£ ho√†n t·∫•t ‚Üí Xo√° UI & script"
	task.wait(1)
	if uiRoot and uiRoot.Parent then
		uiRoot:Destroy()
	end
	if script then
		script:Destroy()
	end
end

-- ====== üåÄ V√≤ng l·∫∑p ch√≠nh ======
task.spawn(function()
	while AUTO_ON do
		local chests = findChests()

		if #chests == 0 then
			failCount += 1
		else
			for _, pos in ipairs(chests) do
				softTpTo(pos)
				task.wait(math.random(5,15)/100) -- ‚è© delay gi·ªØa chest gi·∫£m c√≤n 0.05‚Äì0.15s
			end
			failCount = 0
		end

		if failCount >= MAX_FAIL then
			statusLabel.Text = "Status: Kh√¥ng c√≤n chest ‚Üí Hop server"
			AUTO_ON = false
			serverHop()
			cleanupAndExit()
			break
		end

		task.wait(getScanDelay())
	end
end)
